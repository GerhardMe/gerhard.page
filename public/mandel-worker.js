// mandel-worker.js
// Runs WASM Mandelbrot rendering off the main thread.

self.Module = self.Module || {};
Module = self.Module;

// Load the wasm glue generated by emscripten
importScripts('/mandel.js');

let initFB = null;
let getPtr = null;
let renderFrame = null;
let wasmReady = false;

Module.onRuntimeInitialized = function () {
    initFB = Module.cwrap('init_framebuffer', null, ['number', 'number']);
    getPtr = Module.cwrap('get_framebuffer_ptr', 'number', []);
    renderFrame = Module.cwrap('render_frame', null, [
        'number', // centerX
        'number', // centerY
        'number', // scale
        'number', // maxIter
        'number', // samplesPerDim
        'number', // circX
        'number', // circY
        'number', // circR
    ]);
    wasmReady = true;
    postMessage({ type: 'ready' });
};

self.onmessage = function (e) {
    const msg = e.data;
    if (!wasmReady) return;
    if (msg.type !== 'render') return;

    const {
        jobId,
        fbW,
        fbH,
        worldCenterX,
        worldCenterY,
        worldScale,
        maxIter,
        samplesDim,
        circX,
        circY,
        circR,
    } = msg;

    // Allocate framebuffer and call WASM
    initFB(fbW, fbH);
    const fbPtr = getPtr();

    if (!Module.HEAPU8 || !Module.HEAPU8.buffer) {
        postMessage({ type: 'error', jobId, message: 'no HEAPU8' });
        return;
    }

    const fbView = new Uint8ClampedArray(
        Module.HEAPU8.buffer,
        fbPtr,
        fbW * fbH * 4,
    );

    renderFrame(
        worldCenterX,
        worldCenterY,
        worldScale,
        maxIter,
        samplesDim,
        circX,
        circY,
        circR,
    );

    // Extract grayscale
    const gray = new Uint8Array(fbW * fbH);
    for (let i = 0, j = 0; i < gray.length; i++, j += 4) {
        gray[i] = fbView[j];
    }

    // Send back frame + the viewbox it was computed for
    postMessage(
        {
            type: 'frame',
            jobId,
            fbW,
            fbH,
            gray,
            worldCenterX,
            worldCenterY,
            worldScale,
        },
        [gray.buffer],
    );
};
