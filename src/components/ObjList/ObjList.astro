---
import GroupButtons from "./GroupsBtn.astro";

interface Props {
  media: any[];
  groupBy?: string[];
  favorites?: boolean;
  Item: any; // Component that renders a single item
}

const { media, groupBy = ["read"], favorites = false, Item } = Astro.props;

function fm(post: any) {
  return post.frontmatter ?? post.data ?? {};
}

function isDateValue(val: any) {
  if (val == null || val === "") return false;
  if (typeof val === "number") return false;
  if (typeof val !== "string") return false;
  if (val.length < 6) return false;
  const d = new Date(val);
  return !isNaN(d.getTime());
}

function isDateKey(key: string) {
  const samples = media.slice(0, 10);
  const validDates = samples.filter((p) => isDateValue(fm(p)[key]));
  return validDates.length > samples.length / 2;
}

const dateKeys = groupBy.filter(isDateKey);
const bucketKeys = groupBy.filter((k) => !isDateKey(k));

function buildDateSections(key: string) {
  const sorted = [...media].sort((a, b) => {
    const da = new Date(fm(a)[key] ?? 0).getTime() || 0;
    const db = new Date(fm(b)[key] ?? 0).getTime() || 0;
    return db - da;
  });
  return { desc: sorted, asc: [...sorted].reverse() };
}

function buildBuckets(key: string) {
  const buckets = new Map<string, any[]>();
  for (const post of media) {
    const f = fm(post);
    const raw = f[key];
    const k = raw == null || raw === "" ? `No ${key}` : String(raw);
    if (!buckets.has(k)) buckets.set(k, []);
    buckets.get(k)!.push(post);
  }

  const sortKey = dateKeys[0];
  if (sortKey) {
    for (const [, arr] of buckets) {
      arr.sort((a, b) => {
        const da = new Date(fm(a)[sortKey] ?? 0).getTime() || 0;
        const db = new Date(fm(b)[sortKey] ?? 0).getTime() || 0;
        return db - da;
      });
    }
  }

  const groupsDesc = Array.from(buckets.keys()).sort((a, b) => {
    const na = Number(a);
    const nb = Number(b);
    if (!Number.isNaN(na) && !Number.isNaN(nb)) return nb - na;
    return a.toLowerCase().localeCompare(b.toLowerCase());
  });

  return { groupsDesc, buckets };
}

const dateSections = Object.fromEntries(
  dateKeys.map((k) => [k, buildDateSections(k)])
);

const prebuilt = bucketKeys.map((k) => ({ key: k, ...buildBuckets(k) }));

const favoritesList = favorites ? media.filter((p) => !!fm(p).favorite) : [];

const firstKey = groupBy[0];
---

{/* Favorites section */}
{
  favorites && favoritesList.length > 0 && (
    <ul class="list">
      <h3 class="title">My all time favorites:</h3>
      {favoritesList.map((post: any) => (
        <li class="element">
          <Item post={post} />
        </li>
      ))}
    </ul>
  )
}

<GroupButtons keys={groupBy} />

{/* Date-based keys */}
{
  dateKeys.map((key) => {
    const isFirst = key === firstKey;
    return [
      <section
        class={`groupset ${isFirst ? "" : "hidden"}`}
        data-key={key}
        data-order="desc"
      >
        <ul class="list">
          {dateSections[key].desc.map((post: any) => (
            <li class="element">
              <Item post={post} />
            </li>
          ))}
        </ul>
      </section>,
      <section class="groupset hidden" data-key={key} data-order="asc">
        <ul class="list">
          {dateSections[key].asc.map((post: any) => (
            <li class="element">
              <Item post={post} />
            </li>
          ))}
        </ul>
      </section>,
    ];
  })
}

{/* Bucketed keys */}
{
  prebuilt.flatMap(({ key, groupsDesc, buckets }) => {
    const isFirst = key === firstKey;
    return [
      <section
        class={`groupset ${isFirst ? "" : "hidden"}`}
        data-key={key}
        data-order="desc"
      >
        {groupsDesc.map((g) => {
          const list = buckets.get(g) ?? [];
          if (list.length === 0) return null;
          return (
            <ul class="list">
              <h3 class="title">{g}</h3>
              {list.map((post: any) => (
                <li class="element">
                  <Item post={post} />
                </li>
              ))}
            </ul>
          );
        })}
      </section>,
      <section class="groupset hidden" data-key={key} data-order="asc">
        {[...groupsDesc].reverse().map((g) => {
          const list = buckets.get(g) ?? [];
          if (list.length === 0) return null;
          return (
            <ul class="list">
              <h3 class="title">{g}</h3>
              {list.map((post: any) => (
                <li class="element">
                  <Item post={post} />
                </li>
              ))}
            </ul>
          );
        })}
      </section>,
    ];
  })
}

<style>
  .hidden {
    display: none;
  }

  .list {
    margin: 0em 0.5em 5em 0.5em;
  }

  .title {
    border-bottom: 1px solid var(--color-backdrop);
    padding-bottom: 0.5em;
    font-family: "Times New Roman", Times, serif;
  }

  .element {
    border-bottom: 1px solid var(--color-backdrop);
  }

  .element:last-child {
    border-bottom: none;
  }
</style>

<script is:inline>
  (function () {
    let currentKey =
      document.querySelector(".groupset:not(.hidden)")?.dataset.key ?? "";
    let currentOrder = "desc";

    document.addEventListener("groupby-change", (e) => {
      const key = e.detail?.key;
      if (!key) return;

      const order =
        key === currentKey && currentOrder === "desc" ? "asc" : "desc";
      currentKey = key;
      currentOrder = order;

      document.querySelectorAll(".groupset").forEach((s) => {
        const match = s.dataset.key === key && s.dataset.order === order;
        s.classList.toggle("hidden", !match);
      });
    });
  })();
</script>
