---

---

<div class="canvas-wrapper" id="canvas-wrapper">
  <canvas id="guestbook-canvas"></canvas>
  <canvas id="drawing-canvas"></canvas>
</div>

<div class="controls">
  <button id="draw-mode" class="mode active">Draw</button>
  <button id="text-mode" class="mode">Text</button>
  <div class="brush-control">
    <label>Brush: <span id="brush-value">3</span></label>
    <input type="range" id="brush-size" min="1" max="20" value="3" />
  </div>
  <button id="clear-btn">Clear</button>
  <button id="submit-btn">Submit</button>
  <span id="status"></span>
</div>

<style>
  .canvas-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1.4142;
  }

  #guestbook-canvas,
  #drawing-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  #guestbook-canvas {
    background: #fff;
  }

  #drawing-canvas {
    cursor: crosshair;
  }

  #drawing-canvas.text-mode {
    cursor: text;
  }

  .controls {
    margin-top: 1em;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em;
    align-items: center;
  }

  .mode.active {
    font-weight: bold;
  }

  .brush-control {
    display: flex;
    align-items: center;
    gap: 0.5em;
  }

  .brush-control input {
    width: 80px;
  }
</style>

<script>
  import { initDrawing, setBrushSize, getBrushSize } from "./drawing";
  import { initTextbox, createTextbox, hasActiveTextbox } from "./textbox";

  const API_URL = "/api/guestbook";

  const CANVAS_WIDTH = 1240;
  const CANVAS_HEIGHT = Math.round(1240 * 1.4142);

  const canvasWrapper = document.getElementById("canvas-wrapper")!;
  const guestbookCanvas = document.getElementById(
    "guestbook-canvas"
  ) as HTMLCanvasElement;
  const drawingCanvas = document.getElementById(
    "drawing-canvas"
  ) as HTMLCanvasElement;
  const submitBtn = document.getElementById("submit-btn")!;
  const clearBtn = document.getElementById("clear-btn")!;
  const statusEl = document.getElementById("status")!;
  const drawModeBtn = document.getElementById("draw-mode")!;
  const textModeBtn = document.getElementById("text-mode")!;
  const brushSizeInput = document.getElementById(
    "brush-size"
  ) as HTMLInputElement;
  const brushValueSpan = document.getElementById("brush-value")!;

  const guestbookCtx = guestbookCanvas.getContext("2d")!;
  const drawingCtx = drawingCanvas.getContext("2d")!;

  // Global mode state
  (window as any).guestbookMode = "draw";

  function getCanvasCoords(e: MouseEvent | Touch): { x: number; y: number } {
    const rect = drawingCanvas.getBoundingClientRect();
    const scaleX = CANVAS_WIDTH / rect.width;
    const scaleY = CANVAS_HEIGHT / rect.height;

    const clientX = "clientX" in e ? e.clientX : e.clientX;
    const clientY = "clientY" in e ? e.clientY : e.clientY;

    return {
      x: (clientX - rect.left) * scaleX,
      y: (clientY - rect.top) * scaleY,
    };
  }

  function initCanvases() {
    guestbookCanvas.width = CANVAS_WIDTH;
    guestbookCanvas.height = CANVAS_HEIGHT;
    drawingCanvas.width = CANVAS_WIDTH;
    drawingCanvas.height = CANVAS_HEIGHT;

    initDrawing(drawingCanvas, drawingCtx, getCanvasCoords);
    initTextbox(
      canvasWrapper,
      drawingCtx,
      getCanvasCoords,
      CANVAS_WIDTH,
      CANVAS_HEIGHT
    );

    loadGuestbook();
  }

  async function loadGuestbook() {
    try {
      const response = await fetch(API_URL);
      if (response.ok) {
        const blob = await response.blob();
        const img = new Image();
        img.onload = () => {
          guestbookCtx.drawImage(
            img,
            0,
            0,
            guestbookCanvas.width,
            guestbookCanvas.height
          );
        };
        img.src = URL.createObjectURL(blob);
      }
    } catch (e) {
      console.log("No existing guestbook yet");
    }
  }

  // Mode switching
  drawModeBtn.addEventListener("click", () => {
    (window as any).guestbookMode = "draw";
    drawModeBtn.classList.add("active");
    textModeBtn.classList.remove("active");
    drawingCanvas.classList.remove("text-mode");
  });

  textModeBtn.addEventListener("click", () => {
    (window as any).guestbookMode = "text";
    textModeBtn.classList.add("active");
    drawModeBtn.classList.remove("active");
    drawingCanvas.classList.add("text-mode");
  });

  // Brush size
  brushSizeInput.addEventListener("input", () => {
    const size = parseInt(brushSizeInput.value);
    setBrushSize(size);
    brushValueSpan.textContent = String(size);
  });

  // Text mode click handler
  drawingCanvas.addEventListener("click", (e) => {
    if ((window as any).guestbookMode === "text" && !hasActiveTextbox()) {
      createTextbox(e);
    }
  });

  // Clear drawing layer
  clearBtn.addEventListener("click", () => {
    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
  });

  // Submit
  submitBtn.addEventListener("click", async () => {
    statusEl.textContent = "Submitting...";

    const imageData = drawingCanvas.toDataURL("image/png");

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: imageData }),
      });

      if (response.ok) {
        statusEl.textContent = "Added!";
        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        await loadGuestbook();
      } else {
        throw new Error("Server error");
      }
    } catch (e) {
      statusEl.textContent = "Error submitting";
    }
  });

  initCanvases();
</script>
